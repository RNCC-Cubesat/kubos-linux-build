stages:
  - test
  - deploy

default:
  tags:
    - kubos

.tagged: &tagged  # only build if both kubos and kubos-linux-build are tagged
  rules:
    - if: $KUBOS_TAG && $CI_COMMIT_TAG  # KUBOS_TAG passed from public/kubos (multi-project pipeline)

.build_bbb: &build_bbb
  script:
    - ./build.sh | tee full_build.log
  artifacts:
    name: '$KUBOS_BOARD'
    paths:
      - output/kubos-linux.tar.gz
      - output/aux-sd.tar.gz
      - output/kpack-kubos.itb
      - full_build.log

build_mbm2:
  <<: *tagged
  variables:
    KUBOS_BOARD: pumpkin-mbm2
  <<: *build_bbb

release:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo 'release job'
  release:
    name: 'Release $KUBOS_TAG-$CI_COMMIT_TAG'
    tag_name: '$KUBOS_TAG-$CI_COMMIT_TAG'
    description: 'kubos source $KUBOS_TAG built against kubos-linux-build $CI_COMMIT_TAG'
  rules:
    - if: $KUBOS_TAG =~ /^[0-9]+(\.[0-9]+)*$/
